<!DOCTYPE HTML>
<html lang="en">
	<head>
		<title>Particle sphere</title>
		<meta charset="utf-8">

		<style type="text/css">
			body {
				background-color: #000000;
				margin: 0px;
				font-size: 12px;
				overflow: hidden;
				font-family: helvetica, arial, sans-serif;
			}

			#value{
				display: none;
				position: absolute;
				padding: 20px;
				right: 0px;
				background-color: white;
			}
			#fps{
				color: #777;
				position: absolute;
				bottom: 5px;
				right: 5px;
			}
		</style>
		
	</head>
	<body>
		<div id="fps">fps</div>
		<div id="value">Value</div>
		<!-- 
			blackmill 18458327
			mind your manners 18143761
		-->
		<audio src="https://api.soundcloud.com/tracks/18143761/stream?client_id=74a591aaa5e9a7723d674ccf5fffe0bc" autoplay id="player">
		<!-- <audio src="audio/in-da-club.mp3" autoplay id="player"> -->

		<script src="lib/three.min.js"></script>
		<script src="helpers.js"></script>
		<script src="http://connect.soundcloud.com/sdk.js"></script>
		<script>


			// TODO : add back colors
			// TODO : create pause play for audio
			// TODO : look for further optimizations
			// TODO : explore ways to smooth out (sin cos tan)
			// TODO : add FPS graph like :http://jabtunes.com/labs/particles/experiments_fbo.html
			// TODO : add FPS graph like :http://jabtunes.com/labs/particles/experiments_fbo.html
			// TODO : intensify the particle movement
			// TODO : plug in the URL.
			// TODO : add slider for particle size


			//config
			
			sphereSize = 500;
			baseZoom = 200; //distance from 0,0,0
			zoomMultiplier = 200; //how much the mouse will affect zoom
			panMultiplier = 300; //how much mouse affects pan
			particleBaseSize = 1;
			numberParticles = 5000;
			fps = 60;
			fftSize = 512;

		  SC.initialize({
		    client_id: "74a591aaa5e9a7723d674ccf5fffe0bc"
		  });

		  //use this to get track ID's
		  SC.get("/users/chiddybang/tracks", {limit: 100}, function(tracks){
	      for (var i = 0; i < tracks.length; i++) {
	      	//console.log(tracks[i].title);
	      	//console.log(tracks[i].id);
	      }
	    });

	    /*SC.stream("/tracks/18345900", function(sound){
			  sound.play();
			});*/

			/*SC.get("/tracks/18345900", {limit: 5}, function(track){
	      console.log(track);
	    });*/

		</script>

		<script>
			var lastCalledTime;
			windowWidth = window.innerWidth;
			windowHeight = window.innerHeight;
			// the main three.js components
			var camera, scene, renderer,

			mouseX = 0, mouseY = 0,
			particles

			init();

			function init() {

				// Camera params : 
				// field of view, aspect ratio for render output, near and far clipping plane. 
				camera = new THREE.PerspectiveCamera(80, windowWidth / window.innerHeight, 1, 4000 );
	
				// move the camera backwards so we can see stuff! 
				// default position is 0,0,0. 
				camera.position.z = baseZoom;

				// the scene contains all the 3D object data
				scene = new THREE.Scene();
				
				// camera needs to go in the scene 
				scene.add(camera);

				//add black plane
				/*var geometry = new THREE.PlaneGeometry( 50, 50, 1 );
				var material = new THREE.MeshBasicMaterial( {color: 0xff0000, side: THREE.DoubleSide} );
				plane = new THREE.Mesh( geometry, material );
				scene.add( plane );*/

	
				// and the CanvasRenderer figures out what the 
				// stuff in the scene looks like and draws it!
	 
				renderer = new THREE.WebGLRenderer();
				renderer.setSize( window.innerWidth, window.innerHeight );
	
				// the renderer's canvas domElement is added to the body
				document.body.appendChild( renderer.domElement );
				makeParticles(); 
			
				// add the mouse move listener
				document.addEventListener( 'mousemove', updateMouseCoords, false );
				
				// render 30 times a second (should also look 
				// at requestAnimationFrame) 
				int = setInterval(update,1000/fps); 
			
			}

			function update() {
				renderer.render( scene, camera ); // and render the scene from the perspective of the camera
				updateParticles();
				calcFPS();
			}

			// creates a random field of Particle objects
			function makeParticles() { 
				
				var particleGeom = new THREE.Geometry();
				var material; 
		    var colors = [];

				//CREATE THE SPHERE
				for (var i = 0; i < numberParticles; i++){

					//create particle within half sphere
					var x = -1 + Math.random() * 2;
					var y = -1 + Math.random() * 2;
					var z = Math.abs( -1 + Math.random() * 2 ); //abs = half sphere
					var sphere = spherize(x,y,z);

	        particleGeom.vertices.push(new THREE.Vector3( sphere.x,  sphere.y, sphere.z ));
	        particleGeom.vertices[i].origX = sphere.x
	        particleGeom.vertices[i].origY = sphere.y
	        particleGeom.vertices[i].origZ = sphere.z


	        // vertex colors
	        // random color
	        colors[i] = new THREE.Color(1,1,1);
	        colors[i].setHSL( Math.random(), 1.0, 0.5 );



				}
				particleGeom.colors = colors;
			    
		    // material
		    material = new THREE.PointCloudMaterial({
		        size: particleBaseSize,
		        vertexColors: THREE.VertexColors
		    });

        //material = new THREE.PointCloudMaterial( { size: 1 });
				particles = new THREE.PointCloud(particleGeom, material);
				scene.add( particles );
				
			}
			
			
			function updateParticles() { 

				//AUDIO ------------------------------------

				//get audio data
				frequencyData = new Uint8Array(analyser.frequencyBinCount);
				analyser.getByteFrequencyData(frequencyData);


				//PARTICLES ------------------------------------


				particles.geometry.verticesNeedUpdate = true;
				particles.geometry.colorsNeedUpdate = true;
				var colors = [];
				geometry = particles.geometry;

				// iterate through every particle
				for(var i=0; i<particles.geometry.vertices.length; i++) {
					particle = particles.geometry.vertices[i]; 

					//distance from center determined by mod
					var mod = i%(fftSize/2)
					sphereSize = frequencyData[mod];
					particle.x = particle.origX * sphereSize;
					particle.y = particle.origY * sphereSize;
					particle.z = particle.origZ * sphereSize;

					colors[i] = new THREE.Color(1,1,1);
					//var color = colorize(frequencyData[mod]);
					//particle.material.color.r = color[0];
					//particle.material.color.g = color[1];
					//particle.material.color.b = color[2];

					//move cam zoom in out on mouseY
					var cameraOffset = mouseY/windowHeight - 0.5;
					camera.position.z = baseZoom + cameraOffset * zoomMultiplier;

					//rotate cam left right on mouseX
					var cameraOffset = mouseX/windowWidth - 0.5;
					camera.position.x = cameraOffset * panMultiplier * -1;
					camera.lookAt(new THREE.Vector3(0,0,0));

				}

				geometry.colors = colors;
	
			}

			// --------------------------------------------------------------------------
			// AUDIO STARTS HERE
			// --------------------------------------------------------------------------

			var context = new AudioContext();
			var audioElement = document.getElementById("player");
			var analyser = context.createAnalyser();
			analyser.fftSize = fftSize;

			//audioElement.addEventListener("canplay", function() {
			    var source = context.createMediaElementSource(audioElement);
			    source.connect(analyser);
			    source.connect(context.destination);
			//});


		</script>
	</body>
</html>
